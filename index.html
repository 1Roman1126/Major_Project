<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <h1>Stock Data Analysis</h1>
    <input type="file" id="fileInput">
    <select id="companySelect"></select>

    <!-- Canvas elements for charts -->
    <canvas id="stockPriceChart"></canvas>
    <canvas id="tradingVolumeChart"></canvas>
    <canvas id="marketCapChart"></canvas>
    <canvas id="highLowPricesChart"></canvas>
    <canvas id="priceValueChart"></canvas>

    <button onclick="saveChartImage('stockPriceChart')">Save Stock Price Chart</button>
    <button onclick="saveChartImage('tradingVolumeChart')">Save Trading Volume Chart</button>
    <button onclick="saveChartImage('marketCapChart')">Save Market Cap Chart</button>
    <button onclick="saveChartImage('highLowPricesChart')">Save High/Low Prices Chart</button>
    <button onclick="saveChartImage('priceValueChart')">Save Price/Value Chart</button>
    <button onclick="downloadCSV()">Download CSV Data</button>

    
    <script>
        AWS.config.region = 'your-region'; // e.g., 'us-west-2'
        AWS.config.credentials = new AWS.CognitoIdentityCredentials({
            IdentityPoolId: 'your-identity-pool-id', // Replace with your Identity Pool ID
        });

        var s3 = new AWS.S3();

        let csvData = [];
        let charts = []; // Track chart instances

        // Event listeners for file input and dropdown change
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        document.getElementById('companySelect').addEventListener('change', updateCharts);

        // Function to fetch file from S3
        function fetchS3File() {
            const params = {
                Bucket: 'your-bucket-name', // Replace with your S3 bucket name
                Key: 'your-csv-file-path.csv', // Replace with the CSV file path in the bucket
            };

            s3.getObject(params, function (err, data) {
                if (err) {
                    console.log("Error fetching file", err);
                } else {
                    const csvContent = data.Body.toString('utf-8');
                    parseCSV(csvContent); // Call your CSV parsing function
                }
            });
        }
        // Function to save chart image
    function saveChartImage(chartId) {
        const chartCanvas = document.getElementById(chartId);
        const chart = charts.find(c => c.canvas.id === chartId); // Find chart by its canvas ID
        if (chart) {
            const link = document.createElement('a');
            link.href = chart.toBase64Image(); // Convert chart to base64 image
            link.download = chartId + '.png'; // Set download file name
            link.click(); // Trigger download
        }
    }
        function downloadCSV() {
        const csvContent = Papa.unparse(csvData); // Convert the csvData back to CSV format
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.setAttribute('download', 'stock_data.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

        // Function to handle file upload and parse CSV
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    csvData = results.data;
                    resetCharts(); // Reset charts for new file
                    populateCompanySelect();
                }
            });
        }

        // Function to parse CSV from S3
        function parseCSV(csvContent) {
            Papa.parse(csvContent, {
                header: true,
                skipEmptyLines: true,
                complete: function (results) {
                    csvData = results.data;
                    resetCharts();
                    populateCompanySelect();
                }
            });
        }

        // Function to populate the company selection dropdown
        function populateCompanySelect() {
            const select = document.getElementById('companySelect');
            select.innerHTML = ''; // Clear existing options
            const symbols = [...new Set(csvData.map(row => row.SYMBOL))];

            symbols.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.text = symbol;
                select.add(option);
            });

            if (symbols.length > 0) {
                select.value = symbols[0];
                updateCharts(); // Update charts with the first company
            }
        }

        // Function to update charts based on selected company
        function updateCharts() {
            const selectedSymbol = document.getElementById('companySelect').value;
            const companyData = csvData.filter(row => row.SYMBOL === selectedSymbol);

            if (companyData.length === 0) return;

            const dates = companyData.map(row => row.BUSINESS_DATE);
            const openPrices = companyData.map(row => parseFloat(row.OPEN_PRICE));
            const closePrices = companyData.map(row => parseFloat(row.CLOSE_PRICE));
            const tradedQuantities = companyData.map(row => parseFloat(row.TOTAL_TRADED_QUANTITY));
            const marketCaps = companyData.map(row => parseFloat(row.MARKET_CAPITALIZATION));
            const highPrices = companyData.map(row => parseFloat(row.HIGH_PRICE));
            const lowPrices = companyData.map(row => parseFloat(row.LOW_PRICE));
            const averageTradedPrice = companyData.map(row => parseFloat(row.AVERAGE_TRADED_PRICE));
            const previousDayClosePrice = companyData.map(row => parseFloat(row.PREVIOUS_DAY_CLOSE_PRICE));

            resetCharts();

            drawStockPriceChart(dates, openPrices, closePrices);
            drawTradingVolumeChart(dates, tradedQuantities);
            drawMarketCapChart(dates, marketCaps);
            drawHighLowPricesChart(dates, highPrices, lowPrices);
            drawPriceValueChart(dates, averageTradedPrice, previousDayClosePrice);
        }

        // Function to draw the Stock Prices Chart
        function drawStockPriceChart(dates, openPrices, closePrices) {
            const ctx = document.getElementById('stockPriceChart').getContext('2d');
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Open Price',
                            data: openPrices,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderWidth: 2,
                        },
                        {
                            label: 'Close Price',
                            data: closePrices,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderWidth: 2,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            onClick: function(e, legendItem) {
                                const index = legendItem.datasetIndex;
                                const ci = this.chart;
                                const meta = ci.getDatasetMeta(index);
                                meta.hidden = !meta.hidden; // Toggle dataset visibility
                                ci.update();
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Date' } },
                        y: { title: { display: true, text: 'Price' }, beginAtZero: false }
                    }
                }
            });
            charts.push(chart);
        }

        // Add similar functions for other charts like drawTradingVolumeChart, drawMarketCapChart, drawHighLowPricesChart, and drawPriceValueChart (as defined in the original code)

        // Function to reset and destroy existing charts
        function resetCharts() {
            charts.forEach(chart => chart.destroy());
            charts = [];
        }
    </script>
</body>
</html>
